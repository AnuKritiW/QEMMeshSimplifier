name: GTest CI

on:
  push:
    branches: [github-actions]
  pull_request:
    branches: [github-actions]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [CPU, Metal]
        suite: [ParserTests, QEMSimplifierUtilsTests, QEMSimplifierTests]

    name: Run ${{ matrix.build_type }} ${{ matrix.suite }}

    steps:
      # Step 1: Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Set Up Cache
      - name: Cache CMake Files
        uses: actions/cache@v3
        with:
          path: |
            build-${{ matrix.build_type }}
            ~/.cmake/packages
          key: cmake-cache-${{ matrix.build_type }}-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            cmake-cache-${{ matrix.build_type }}-${{ runner.os }}-

      # Step 3: Install System Dependencies
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            wget \
            libglfw3-dev \
            libglew-dev \
            freeglut3-dev \
            libx11-dev \
            libxi-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev

      # Step 4: Configure CMake
      - name: Configure CMake
        run: |
          mkdir -p build-${{ matrix.build_type }} && cd build-${{ matrix.build_type }}
          if [ "${{ matrix.build_type }}" == "Metal" ]; then
            cmake -DUSE_METAL=ON -DCMAKE_BUILD_TYPE=Release ..
          else
            cmake -DCMAKE_BUILD_TYPE=Release ..
          fi

      # Step 5: Build the Project
      - name: Build the Project
        run: |
          cmake --build build-${{ matrix.build_type }} -- -j$(nproc)

      # Step 6: Run the Test Suite
      - name: Run Test Suite
        run: |
          cd build-${{ matrix.build_type }}
          ctest --output-on-failure --tests-regex "${{ matrix.suite }}"
